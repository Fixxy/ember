{% extends 'template.html' %}
{% block content %}
<div id="main" class="row">
	<div id="cover" class="col-md-3"></div>
	<div id="data" class="col-md-9"></div>
</div>
<script>

function getData(button_id, service, se, ep, title) {
	$(button_id + se + ep).on('click', function(){
	$('#torList' + se + ep).empty();
	$('#torLoad' + se + ep).show();
		$.ajax({
			type: 'GET',
			url: '/' + service + '/S' + se + 'E' + ep + ' ' + title,
			dataType: 'json',
			success: function(msg) {
				$.each(msg, function(i, v) {
					$('#torList' + se + ep).append('<li class="list-group-item"><input type="radio" name="radioButtons" id="radio' + i + '" magnet="' + v[1] + '" hash="' + v[3] + '"><span class="badge badge-seeds">' + v[2] + '</span> ' + v[0] + '</li>');
					//console.log('each: ' + i + '' + v)
				});
				$('#torLoad' + se + ep).hide();
				$('#torList' + se + ep).show();
			},
			error: function (xhr, status, error) {
				console.log(error);
			}
		});
	});
    return;
}

// progress bar from deluge
function progressBar(hash) {
	$.ajax({
		dataType: "json",
		cache: true,
		url: "/progress/" + hash,
		success: function(data) {
			$('#data').append('<div class="progress">' +
			'<div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="' + data +
			'" aria-valuemin="0" aria-valuemax="100" style="width:' + data + '%">' + data + '%</div></div>');
			setTimeout(progressBar(), 10000);
		},
		//nothing was found
		error: function(data) {
			$('#data').append('<div class="progress">' +
			'<div class="progress-bar progress-bar-danger progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%">0%</div></div>');
		}
	});
}
	
$(function() {
	var data = {{data|safe}};
	var epdata = {{epdata|safe}};
	var table = "{{table|safe}}";
	$('#cover').empty();
	$('#cover').append('<div class="thumbnail"><img src="' + data[0]["img_small"] + '"/></div>');
	$('#data').empty();

	/*$('#data').append('<h4>' + data[0]["title"] + '</h4>' + 
	'<div><b>Year:</b> ' + data[0]["year"] + '</div>' + 
	'<div><b>Description:</b> ' + data[0]["description"] + '</div>' + 
	'<div><b>Rating:</b> ' + data[0]["rating"] + '</div>' + 
	'<div><b>Director:</b> ' + data[0]["director"] + '</div>' + 
	'<div><b>URL:</b> ' + data[0]["url"] + '</div>');*/
	$('#data').append('<h4>' + data[0]["title"] + ((data[0]["year"] != "") ? ' (' + data[0]["year"] + ')' : '')  + '</h4>' + 
	'<div>' + data[0]["description"] + '</div>' + 
	'<a href="' + data[0]["url"] + '"><div class="imdb-rating">' + data[0]["rating"] + '</div></a>' + 
	'<div><b>Director:</b> ' + data[0]["director"] + '</div>');

	if (table == 'tv_shows') {
		$('#data').append('<div><b>status:</b> ' + data[0]["status"] + '</div>');
		$('#data').append('<div class="panel-group" id="accordion">');
		if (epdata[0] != null) {
			$.each(epdata, function(i, v) { // for each entry
				var se = v["se_num"]; var ep = v["ep_num"];
				if (se < 10){ se = "0" + se }; if (ep < 10){ ep = "0" + ep };
				
				$('#data').append('<div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title">' +
				'<a data-toggle="collapse" data-parent="#accordion" href="#collapse' + i +'">' +
				'<strong>S' + se + 'E' + ep + ' | ' + v["title"] + '</strong>' +
				'</a></h3></div><div id="collapse' + i + '" class="panel-collapse collapse">' +
				'<div class="panel-body"><img width="300px" src="' + v["screenshot"] + '"/>' +
				'</br></br><div class="well well-sm">' + v["description"] + '</div>' +
				'<button id="tpbsearch' + se + ep + '" name="tpbsearch" type="button" class="btn btn-warning">Search on TPB</button>' +
				'<button id="eztvsearch' + se + ep + '" name="eztvsearch" type="button" class="btn btn-primary">Search on EZTV</button>' +
				'</div><div id="torLoad' + se + ep + '" style="display: none;">' +
				'<img src="../../static/spinner.gif"/></div>' +
				'<ul class="list-group" id="torList' + se + ep + '"></ul>' +
				'</div></div>')
				
				getData('#tpbsearch', 'tpb', se, ep, data[0]["title"]);
				getData('#eztvsearch', 'eztv', se, ep, data[0]["title"]);

			});
		} else {
			$('#data').append('No episodes available</div>');
		}
		$('#data').append('</div>');
	} else {
			$('#data').append('<div><b>hash:</b> ' + data[0]["hash"] + '</div>');
			progressBar(data[0]["hash"]);
	}

	if (data[0]["folder"] != "") {
		$('#main').append('<video width="800" controls><source src="..\\..\\media\\' + data[0]["imdb_id"] + '\\' + data[0]["folder"] + '" type="video/mp4">Your browser does not support HTML5 video.</video>');
	}
});

</script>


{% endblock %}